# 书籍推荐系统使用说明

## 功能概述

本系统实现了完整的书籍推荐功能，包括：

1. **推荐算法**：采用"基于内容推荐+协同过滤"混合算法
2. **推荐场景**：
   - 首页个性化推荐（10本）
   - 书籍详情页相似书籍推荐（5本）
3. **推荐更新**：每日凌晨自动更新推荐结果
4. **结果展示**：显示推荐依据（如"基于您的阅读历史""基于内容相似度"）
5. **个性化调整**：支持用户设置推荐偏好（平衡/热门/小众）

## 安装和配置

### 1. 数据库迁移

系统启动时会自动创建以下新表：
- `user_recommendation_preference` - 用户推荐偏好设置
- `book_recommendation` - 书籍相似推荐缓存
- `user_recommendation` - 用户个性化推荐缓存

### 2. 定时任务配置

推荐系统已集成到现有的定时任务系统中，会在每日凌晨自动更新推荐结果。

## 使用方法

### 用户端

1. **查看个性化推荐**
   - 登录后访问首页
   - 在页面顶部会显示"个性化推荐"区域
   - 显示10本根据您的阅读历史推荐的书籍

2. **查看相似书籍**
   - 点击任意书籍进入详情页
   - 在书籍描述下方会显示"相似书籍"区域
   - 显示5本与当前书籍相似的推荐

3. **设置推荐偏好**
   - 点击右上角用户头像 → "账户"
   - 在"推荐偏好"下拉菜单中选择：
     - **平衡**：内容推荐和协同过滤各占50%
     - **热门**：侧重协同过滤，推荐热门书籍
     - **小众**：侧重内容推荐，推荐相似内容

### 管理员端

1. **手动触发推荐更新**
   - 可以通过定时任务系统手动触发推荐更新任务
   - 任务会更新所有用户的推荐结果

## 测试推荐系统

### 使用爬虫脚本添加测试数据

```bash
# 激活虚拟环境（如果使用）
conda activate calibre-web

# 运行爬虫脚本
python scripts/test_recommendation_spider.py
```

脚本会从 Open Library API 爬取书籍数据并添加到数据库，用于测试推荐系统。

### 测试步骤

1. **准备数据**
   - 运行爬虫脚本添加测试书籍
   - 或者手动添加一些书籍到数据库

2. **模拟用户行为**
   - 登录系统
   - 标记几本书为"已读"
   - 等待推荐系统生成推荐（或手动触发更新）

3. **验证推荐**
   - 检查首页是否显示个性化推荐
   - 点击书籍查看相似书籍推荐
   - 调整推荐偏好，观察推荐结果变化

## 技术实现

### 推荐算法

1. **基于内容推荐**
   - 提取书籍特征：作者、标签、系列、出版社、语言、评分
   - 使用余弦相似度计算书籍相似度
   - 适用于新用户或冷启动场景

2. **协同过滤推荐**
   - 找到阅读过相同书籍的相似用户
   - 推荐相似用户喜欢但当前用户未读的书籍
   - 适用于有足够用户行为数据的场景

3. **混合推荐**
   - 根据用户偏好调整两种算法的权重
   - 平衡推荐：内容60% + 协同40%
   - 热门推荐：内容30% + 协同70%
   - 小众推荐：内容80% + 协同20%

### 性能优化

1. **推荐结果缓存**
   - 推荐结果缓存24小时
   - 用户行为变化时触发增量更新
   - 定时任务每日凌晨全量更新

2. **数据库索引**
   - 推荐相关表已建立必要的索引
   - 查询优化确保快速响应

## API接口

### 获取推荐偏好

```
GET /ajax/recommendation_preference
```

返回：
```json
{
  "preference": "balanced"
}
```

### 更新推荐偏好

```
POST /ajax/recommendation_preference
Content-Type: application/json

{
  "preference": "popular"
}
```

返回：
```json
{
  "success": true,
  "preference": "popular"
}
```

## 注意事项

1. **数据要求**
   - 推荐系统需要至少有一些书籍数据才能工作
   - 协同过滤需要多个用户和阅读历史数据
   - 新系统建议先使用基于内容的推荐

2. **性能考虑**
   - 大量书籍时，推荐计算可能较慢
   - 建议在低峰期运行定时任务
   - 缓存机制确保用户访问时快速响应

3. **隐私保护**
   - 推荐系统只使用用户的阅读历史数据
   - 不收集其他个人信息
   - 推荐结果仅对用户本人可见

## 故障排除

### 推荐不显示

1. 检查是否有足够的书籍数据
2. 检查用户是否有阅读历史
3. 查看日志文件确认是否有错误

### 推荐更新失败

1. 检查定时任务是否正常运行
2. 查看任务状态页面确认任务执行情况
3. 检查数据库连接是否正常

### 推荐质量不佳

1. 尝试调整推荐偏好设置
2. 增加更多书籍数据
3. 增加用户阅读历史数据

## 开发扩展

如需扩展推荐系统，可以：

1. 修改 `cps/recommendation.py` 中的算法
2. 添加新的推荐特征（如评分、评论等）
3. 实现更复杂的推荐策略
4. 添加A/B测试功能

## 更新日志

- v1.0.0: 初始版本，实现基础推荐功能
  - 基于内容推荐
  - 协同过滤推荐
  - 混合推荐算法
  - 定时任务更新
  - 用户偏好设置

